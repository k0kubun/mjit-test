box: k0kubun/ruby:2.6.0-preview2
no-response-timeout: 30
command-timeout: 60
build:
  steps:
    - script:
        name: install tzdata and sudo
        code: apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata sudo
    - script:
        name: workaround ipv6 localhost
        code: ruby -e "hosts = File.read('/etc/hosts').sub(/^::1\s*localhost.*$/, ''); File.write('/etc/hosts', hosts)"
    - script:
        name: checkout again
        code: rm -rf .git .travis.yml * && git clone --depth=1 https://github.com/ruby/ruby . && git log -n1
    - script:
        name: create non-root user
        code: useradd test && chown -R test:test .
    - script:
        name: configure
        code: |
          sudo -u test -E -- bash -c "sudo autoconf && ./configure --disable-install-doc --prefix=/tmp/ruby-prefix"
    - script:
        name: make all install
        code: |
          sudo -u test -E -- bash -c "make -j$(nproc) all install"
    - script:
        name: make test-all
        code: |
          sudo -u test -E -- bash -c "make test-all TESTOPTS='--color=never --job-status=normal' RUN_OPTS='--disable-gems' RUBY_FORCE_TEST_JIT=1"
    - script:
        name: make test-spec
        code: |
          sudo -u ruby -E -- bash -c "make test-spec RUN_OPTS='--disable-gems' RUBYOPT='--disable-gems'"
    - script:
        name: make test
        code: |
          sudo -u ruby bash -c "make test RUN_OPTS='--disable-gems'"
    # - script:
    #     name: make test-all (JIT)
    #     code: make test-all TESTOPTS='--color=never --job-status=normal' RUN_OPTS='--disable-gems --jit-wait --jit-warnings' RUBY_FORCE_TEST_JIT=1
    # - script:
    #     name: make test-spec (JIT)
    #     code: make test-spec RUN_OPTS='--disable-gems --jit-wait --jit-warnings' RUBYOPT='--disable-gems --jit-wait --jit-warnings'
    # - script:
    #     name: make test (JIT)
    #     code: make test RUN_OPTS='--disable-gems --jit-wait --jit-warnings'
